{% extends "base.html" %}
{% load static %}

{% block title %}Edit Blog - BlogerMenia{% endblock %}

{% block extra_head %}
<!-- Lucide Icons -->
<script src="https://unpkg.com/lucide@latest"></script>
<!-- Remark/Rehype for Markdown Preview (Optional, keeping simple for now) -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    /* Custom Scrollbar for Chat */
    .chat-scroll::-webkit-scrollbar {
        width: 6px;
    }

    .chat-scroll::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .chat-scroll::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }

    .chat-scroll::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
</style>
{% endblock %}

{% block content %}
<div class="py-12">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Chat Section (UI Only) -->
        <div class="mb-6 bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="bot" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-900">AI Blog Assistant</h3>
                        <p class="text-sm text-gray-600">Need help refining your content? Ask me!</p>
                    </div>
                </div>
                <button onclick="toggleChat()" id="toggleChatBtn"
                    class="text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                    Show Chat
                </button>
            </div>

            <div id="chatSection" class="hidden">
                <!-- Chat History -->
                <div id="chatHistory" class="max-h-96 overflow-y-auto mb-4 space-y-3 chat-scroll"
                    style="scroll-behavior: smooth;">
                    <!-- Messages will be injected here -->
                </div>

                <!-- Chat Input -->
                <div class="flex gap-2">
                    <input type="text" id="chatInput" placeholder="Ask for suggestions or changes..."
                        class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" />
                    <button onclick="handleChatSend()" id="sendBtn"
                        class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg font-medium hover:from-indigo-700 hover:to-purple-700 transition-all duration-300 flex items-center gap-2">
                        <i data-lucide="send" class="w-5 h-5"></i>
                        <span id="sendBtnText">Send</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Form -->
        <form method="POST" enctype="multipart/form-data" id="blogForm">
            {% csrf_token %}

            <!-- Hidden Input for Sections JSON -->
            <!-- Initial Value: Try form value (error case), fallback to object.sections (edit case) -->
            <!-- We handle actual loading in JS via json_script to be safe against python string repr -->
            <input type="hidden" name="sections" id="sectionsInput">

            <!-- Data for JS -->
            {% if form.sections.value %}
            <!-- If form validation failed, this has the submitted JSON string -->
            {{ form.sections.value|json_script:"initial-sections-data-form" }}
            {% else %}
            <!-- If initial load, object.sections is a Python list/dict. We need to serialize it. -->
            <!-- Django's json_script serializes context variables safely -->
            {{ object.sections|json_script:"initial-sections-data-object" }}
            {% endif %}


            <!-- Header -->
            <div class="mb-6 flex items-center justify-between">
                <div>
                    <a href="{% url 'user-blogs' user.username %}"
                        class="flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-2">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i>
                        Back to My Blogs
                    </a>
                    <h1 class="text-3xl font-bold text-gray-900">Edit Blog</h1>
                </div>
                <div class="flex items-center gap-3">
                    <label
                        class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-medium hover:from-purple-700 hover:to-pink-700 transition-all duration-300 shadow-lg shadow-purple-500/30 cursor-pointer">
                        <i data-lucide="upload" class="w-5 h-5"></i>
                        Load JSON
                        <input type="file" accept=".json" onchange="handleLoadJSON(event)" class="hidden" />
                    </label>
                    <button type="submit"
                        class="flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-indigo-600 to-violet-600 text-white rounded-lg font-medium hover:from-indigo-700 hover:to-violet-700 transition-all duration-300 shadow-lg shadow-indigo-500/30">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        Update Blog
                    </button>
                </div>
            </div>

            <!-- Error Messages -->
            {% if form.errors %}
            <div class="mb-6 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded relative" role="alert">
                <strong class="font-bold">Please correct the errors below:</strong>
                <ul class="mt-2 list-disc list-inside text-sm">
                    {% for field in form %}
                    {% for error in field.errors %}
                    <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Basic Information -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Basic Information</h2>
                <div class="space-y-4">
                    <div
                        class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-100 mb-4">
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-gray-900">Publish Immediately</span>
                            <span class="text-xs text-gray-500">Make this blog visible to everyone upon saving.</span>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            {{ form.isPublished }}
                            <div
                                class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600">
                            </div>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                        <input type="text" name="title" id="titleInput"
                            value="{{ form.title.value|default:object.title }}"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="Enter blog title" required />
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <div class="flex items-center justify-between mb-1">
                                <label class="block text-sm font-medium text-gray-700">Slug</label>
                                <span class="text-xs text-gray-500 italic">Auto-generated</span>
                            </div>
                            <input type="text" name="slug" id="slugInput"
                                value="{{ form.slug.value|default:object.slug }}"
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600 focus:outline-none cursor-not-allowed"
                                placeholder="blog-slug-url" readonly required />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                            <div class="relative">
                                {{ form.category }}
                                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-500"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Subtitle</label>
                        <input type="text" name="subtitle" value="{{ form.subtitle.value|default_if_none:'' }}"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            placeholder="Enter subtitle" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Excerpt</label>
                        <textarea name="excerpt"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                            rows="3"
                            placeholder="Short description">{{ form.excerpt.value|default_if_none:'' }}</textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Thumbnail Image</label>
                        <div id="dropzone"
                            class="border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition-colors relative h-48 group">

                            {{ form.thumbnail }}

                            <div id="dropzoneContent"
                                class="text-center pointer-events-none {% if object.thumbnail %}hidden{% endif %}">
                                <div
                                    class="w-12 h-12 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                                    <i data-lucide="cloud-upload" class="w-6 h-6"></i>
                                </div>
                                <p class="text-sm font-medium text-gray-900">Click or Drag & Drop</p>
                                <p class="text-xs text-gray-500 mt-1">SVG, PNG, JPG or GIF (max. 2MB)</p>
                            </div>

                            <!-- Preview Image -->
                            <img id="imagePreview" src="{% if object.thumbnail %}{{ object.thumbnail.url }}{% endif %}"
                                alt="Preview"
                                class="{% if not object.thumbnail %}hidden{% endif %} absolute inset-0 w-full h-full object-cover rounded-lg">

                            <!-- Remove Button -->
                            <button type="button" id="removeImageBtn"
                                class="{% if not object.thumbnail %}hidden{% endif %} absolute top-2 right-2 p-1 bg-white rounded-full shadow-md text-red-500 hover:bg-red-50 z-10"
                                onclick="removeThumbnail(event)">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>


                </div>
            </div>

            <!-- Introduction -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Introduction</h2>
                <textarea name="introduction" id="introductionInput"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    rows="4"
                    placeholder="Write the introduction for your blog...">{{ form.introduction.value|default_if_none:'' }}</textarea>
            </div>

            <!-- Sections -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900">Content Sections</h2>
                </div>

                <div id="sectionsContainer" class="space-y-4 mb-6">
                    <!-- Dynamic Sections will appear here -->
                    <div id="emptySectionsMsg"
                        class="text-center py-8 text-gray-500 italic border-2 border-dashed border-gray-200 rounded-lg">
                        No sections yet. Add one from the toolbar below.
                    </div>
                </div>

                <!-- Section Buttons Toolbar (Moved to Bottom) -->
                <div class="flex items-center justify-center flex-wrap gap-2 pt-4 border-t border-gray-100">
                    <span class="text-sm font-medium text-gray-500 mr-2">Add Section:</span>
                    <button type="button" onclick="addSection('text')"
                        class="flex items-center gap-2 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i data-lucide="type" class="w-4 h-4"></i> Text
                    </button>
                    <button type="button" onclick="addSection('bullets')"
                        class="flex items-center gap-2 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i data-lucide="list" class="w-4 h-4"></i> Bullets
                    </button>
                    <button type="button" onclick="addSection('code')"
                        class="flex items-center gap-2 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i data-lucide="code" class="w-4 h-4"></i> Code
                    </button>
                    <button type="button" onclick="addSection('table')"
                        class="flex items-center gap-2 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i data-lucide="table" class="w-4 h-4"></i> Table
                    </button>
                    <button type="button" onclick="addSection('youtube')"
                        class="flex items-center gap-2 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i data-lucide="youtube" class="w-4 h-4"></i> Video
                    </button>
                    <button type="button" onclick="addSection('note')"
                        class="flex items-center gap-2 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i data-lucide="file-text" class="w-4 h-4"></i> Note
                    </button>
                    <button type="button" onclick="addSection('image')"
                        class="flex items-center gap-2 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        <i data-lucide="image" class="w-4 h-4"></i> Image
                    </button>
                </div>
            </div>

            <!-- Conclusion -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Conclusion</h2>
                <textarea name="conclusion" id="conclusionInput"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                    rows="4"
                    placeholder="Write the conclusion for your blog...">{{ form.conclusion.value|default_if_none:'' }}</textarea>
            </div>

            <!-- Save Button Footer -->
            <div class="flex justify-end mb-8">
                <button type="submit"
                    class="flex items-center gap-2 px-8 py-3 bg-gradient-to-r from-indigo-600 to-violet-600 text-white rounded-lg font-medium hover:from-indigo-700 hover:to-violet-700 transition-all duration-300 shadow-lg shadow-indigo-500/30">
                    <i data-lucide="save" class="w-5 h-5"></i>
                    Update Blog
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Initialize Lucide Icons
    lucide.createIcons();

    // -----------------------------------------------------
    // State Management
    // -----------------------------------------------------
    let sections = [];
    let autoSlug = false; // Disable auto-slug on edit unless title changes and slug is empty (usually we keep existing slug)

    // Initialize logic
    // We check for json_script tags
    try {
        const sectionsFromForm = document.getElementById('initial-sections-data-form');
        const sectionsFromObject = document.getElementById('initial-sections-data-object');

        if (sectionsFromForm) {
            const raw = JSON.parse(sectionsFromForm.textContent);
            // If it came from the hidden input during error, it might be a JSON string inside a string
            if (typeof raw === 'string') {
                sections = JSON.parse(raw);
            } else {
                sections = raw;
            }
        } else if (sectionsFromObject) {
            sections = JSON.parse(sectionsFromObject.textContent);
        }

        // Ensure IDs exist
        if (Array.isArray(sections)) {
            sections = sections.map((s, i) => ({ ...s, id: s.id || Date.now() + i }));
            setTimeout(() => renderSections(), 0);
        } else {
            sections = [];
        }

    } catch (e) {
        console.error("Failed to parse initial sections:", e);
    }

    // -----------------------------------------------------
    // Slug Generation
    // -----------------------------------------------------
    const titleInput = document.getElementById('titleInput');
    const slugInput = document.getElementById('slugInput');
    const slugAutoLabel = document.getElementById('slugAutoLabel');

    function generateSlug(text) {
        return text
            .toLowerCase()
            .trim()
            .replace(/[^\w\s-]/g, '')
            .replace(/[\s_-]+/g, '-')
            .replace(/^-+|-+$/g, '');
    }

    if (titleInput && slugInput) {
        titleInput.addEventListener('input', function () {
            slugInput.value = generateSlug(this.value);
        });
    }

    // Since slug is readonly, we don't need manual input listeners
    // if (slugInput) { ... }

    // -----------------------------------------------------
    // Section Management
    // -----------------------------------------------------
    function addSection(type) {
        const newSection = {
            id: Date.now(),
            type: type,
            title: "",
            content: "",
            items: type === "bullets" ? [""] : undefined,
            headers: type === "table" ? ["", ""] : undefined,
            rows: type === "table" ? [["", ""]] : undefined,
            language: type === "code" ? "javascript" : undefined,
            videoId: type === "youtube" ? "" : undefined,
            videoTitle: type === "youtube" ? "" : undefined,
            description: (type === "youtube" || type === "image") ? "" : undefined,
            imageUrl: type === "image" ? "" : undefined,
        };
        sections.push(newSection);
        renderSections();
        const emptyMsg = document.getElementById('emptySectionsMsg');
        if (emptyMsg) emptyMsg.style.display = 'none';
    }

    function removeSection(id) {
        sections = sections.filter(s => s.id !== id);
        renderSections();
        if (sections.length === 0) {
            const emptyMsg = document.getElementById('emptySectionsMsg');
            if (emptyMsg) emptyMsg.style.display = 'block';
        }
    }

    function moveSection(index, direction) {
        if ((direction === 'up' && index === 0) || (direction === 'down' && index === sections.length - 1)) return;

        const targetIndex = direction === 'up' ? index - 1 : index + 1;
        [sections[index], sections[targetIndex]] = [sections[targetIndex], sections[index]];
        renderSections();
    }

    function updateSectionValue(id, field, value) {
        const section = sections.find(s => s.id === id);
        if (section) {
            section[field] = value;
        }
    }

    function addBullet(id) {
        const section = sections.find(s => s.id === id);
        if (section) {
            if (!section.items) section.items = [];
            section.items.push("");
            renderSections();
        }
    }

    function removeBullet(id, index) {
        const section = sections.find(s => s.id === id);
        if (section) {
            section.items.splice(index, 1);
            renderSections();
        }
    }

    function updateBullet(id, index, value) {
        const section = sections.find(s => s.id === id);
        if (section) {
            section.items[index] = value;
        }
    }

    // -----------------------------------------------------
    // Rendering Logic
    // -----------------------------------------------------
    function renderSections() {
        const container = document.getElementById('sectionsContainer');
        container.innerHTML = '';

        if (sections.length === 0) {
            container.innerHTML = '<div id="emptySectionsMsg" class="text-center py-8 text-gray-500 italic border-2 border-dashed border-gray-200 rounded-lg">No sections yet. Add one from the toolbar above.</div>';
            return;
        }

        sections.forEach((section, index) => {
            const el = document.createElement('div');
            el.className = 'border border-gray-300 rounded-lg p-4 space-y-4 bg-gray-50';

            // Header: Move/Delete controls
            let html = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <button type="button" onclick="moveSection(${index}, 'up')" ${index === 0 ? 'disabled' : ''} class="p-1 rounded hover:bg-gray-200 disabled:opacity-30">
                            <i data-lucide="chevron-up" class="w-4 h-4"></i>
                        </button>
                         <button type="button" onclick="moveSection(${index}, 'down')" ${index === sections.length - 1 ? 'disabled' : ''} class="p-1 rounded hover:bg-gray-200 disabled:opacity-30">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </button>
                        <span class="text-sm font-bold text-gray-700 uppercase tracking-wider">${section.type}</span>
                    </div>
                    <button type="button" onclick="removeSection(${section.id})" class="p-1 text-red-600 hover:bg-red-50 rounded">
                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                    </button>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Section Title</label>
                    <input type="text" value="${section.title || ''}" oninput="updateSectionValue(${section.id}, 'title', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Section title">
                </div>
            `;

            // Specific Content
            if (section.type === 'text') {
                html += `
                    <textarea oninput="updateSectionValue(${section.id}, 'content', this.value)" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Write your content...">${section.content || ''}</textarea>
                `;
            } else if (section.type === 'bullets') {
                html += `<div class="space-y-2">`;
                (section.items || []).forEach((item, i) => {
                    html += `
                        <div class="flex gap-2">
                            <input type="text" value="${item}" oninput="updateBullet(${section.id}, ${i}, this.value)" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Bullet point">
                             <button type="button" onclick="removeBullet(${section.id}, ${i})" class="p-2 text-red-600 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `;
                });
                html += `
                    <button type="button" onclick="addBullet(${section.id})" class="flex items-center gap-2 px-3 py-2 text-sm border border-gray-300 rounded-lg hover:bg-gray-100">
                        <i data-lucide="plus" class="w-4 h-4"></i> Add Bullet Point
                    </button>
                </div>`;
            } else if (section.type === 'code') {
                html += `
                     <div class="space-y-2">
                        <input type="text" value="${section.language || ''}" oninput="updateSectionValue(${section.id}, 'language', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Language (e.g., javascript, python)">
                        <textarea oninput="updateSectionValue(${section.id}, 'content', this.value)" rows="6" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 font-mono text-sm" placeholder="Paste your code here...">${section.content || ''}</textarea>
                     </div>
                `;
            } else if (section.type === 'image') {
                html += `
                    <div class="space-y-4">
                        <!-- File Upload UI -->
                        <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 flex flex-col items-center justify-center bg-white hover:bg-gray-50 transition-colors text-center relative">
                            ${section.imageUrl
                        ? `<img src="${section.imageUrl}" class="max-h-64 rounded shadow-sm mb-4">`
                        : `
                                    <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center mb-3">
                                        <i data-lucide="image-plus" class="w-6 h-6"></i>
                                    </div>
                                    <p class="text-sm text-gray-600">Upload an image for this section</p>
                                `
                    }
                            
                            <input type="file" id="file-${section.id}" class="hidden" accept="image/*" onchange="handleSectionImageUpload(${section.id}, this)">
                            
                            <div class="mt-4 flex gap-2">
                                <label for="file-${section.id}" class="cursor-pointer px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 flex items-center gap-2 shadow-sm">
                                    <i data-lucide="upload-cloud" class="w-4 h-4"></i> ${section.imageUrl ? 'Change Image' : 'Choose File'}
                                </label>
                                ${section.imageUrl ? `
                                    <button type="button" onclick="updateSectionValue(${section.id}, 'imageUrl', '')" class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg text-xs font-medium border border-red-200">
                                        Remove
                                    </button>
                                ` : ''}
                            </div>
                             <span id="upload-status-${section.id}" class="text-xs text-indigo-600 mt-2 font-medium hidden">Uploading...</span>
                        </div>

                        <!-- Fallback URL Input (Hidden or separate tab if needed) -->
                        <div class="relative">
                            <i data-lucide="link" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                            <input type="text" value="${section.imageUrl || ''}" oninput="updateSectionValue(${section.id}, 'imageUrl', this.value)" class="w-full pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Or paste image URL directly...">
                        </div>

                        <textarea oninput="updateSectionValue(${section.id}, 'description', this.value)" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Image description or caption">${section.description || ''}</textarea>
                    </div>
                `;
            } else if (section.type === 'youtube') {
                html += `
                    <div class="space-y-2">
                        <input type="text" value="${section.videoId || ''}" oninput="updateSectionValue(${section.id}, 'videoId', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="YouTube Video ID">
                        <input type="text" value="${section.videoTitle || ''}" oninput="updateSectionValue(${section.id}, 'videoTitle', this.value)" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Video Title">
                         <textarea oninput="updateSectionValue(${section.id}, 'description', this.value)" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Video description">${section.description || ''}</textarea>
                    </div>
                `;
            } else if (section.type === 'note') {
                html += `
                    <textarea oninput="updateSectionValue(${section.id}, 'content', this.value)" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-yellow-50" placeholder="Write your note or callout...">${section.content || ''}</textarea>
                `;
            } else if (section.type === 'table') {
                html += `<div class="p-4 bg-yellow-50 rounded border border-yellow-200 text-sm text-yellow-800">Table editing is simplified in this version. Use JSON import for complex tables.</div>`;
            }

            el.innerHTML = html;
            container.appendChild(el);
        });

        // Re-init icons for new elements
        lucide.createIcons();
    }

    // -----------------------------------------------------
    // JSON Import Logic
    // -----------------------------------------------------
    function handleLoadJSON(event) {
        const file = event.target.files?.[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const jsonData = JSON.parse(e.target.result);
                // Handle both single blog object and blogs array
                const blogData = jsonData.blogs ? jsonData.blogs[0] : jsonData;

                // Fill fields
                if (blogData.title) document.querySelector('[name="title"]').value = blogData.title;
                if (blogData.slug) {
                    document.querySelector('[name="slug"]').value = blogData.slug;
                    // autoSlug = false;
                }
                if (blogData.subtitle) document.querySelector('[name="subtitle"]').value = blogData.subtitle;
                if (blogData.excerpt) document.querySelector('[name="excerpt"]').value = blogData.excerpt;
                if (blogData.content && blogData.content.introduction) document.querySelector('[name="introduction"]').value = blogData.content.introduction;
                if (blogData.content && blogData.content.conclusion) document.querySelector('[name="conclusion"]').value = blogData.content.conclusion;

                // Load sections
                if (blogData.content && blogData.content.sections && Array.isArray(blogData.content.sections)) {
                    sections = blogData.content.sections.map((s, i) => ({ ...s, id: Date.now() + i }));
                    renderSections();
                }

                alert("JSON loaded successfully!");
            } catch (error) {
                console.error(error);
                alert("Failed to load JSON file.");
            }
        };
        reader.readAsText(file);
    }

    // -----------------------------------------------------
    // Chat Logic (Mock)
    // -----------------------------------------------------
    function toggleChat() {
        const chatSection = document.getElementById('chatSection');
        const btnFn = document.getElementById('toggleChatBtn');
        if (chatSection.classList.contains('hidden')) {
            chatSection.classList.remove('hidden');
            btnFn.innerText = 'Hide Chat';
        } else {
            chatSection.classList.add('hidden');
            btnFn.innerText = 'Show Chat';
        }
    }

    async function handleChatSend() {
        // ... (Same chat logic as create, works if relevant) ...
        const input = document.getElementById('chatInput');
        const text = input.value.trim();
        if (!text) return;

        // Add user message
        const history = document.getElementById('chatHistory');
        history.innerHTML += `
            <div class="flex gap-3 justify-end">
                <div class="max-w-[80%] rounded-lg p-3 bg-indigo-600 text-white">
                    <p class="text-sm">${text}</p>
                </div>
                 <div class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <i data-lucide="user" class="w-4 h-4 text-indigo-600"></i>
                </div>
            </div>
        `;
        input.value = '';
        lucide.createIcons();
        history.scrollTop = history.scrollHeight;

        const btnText = document.getElementById('sendBtnText');
        const sendBtn = document.getElementById('sendBtn');
        const originalBtnText = btnText ? btnText.innerText : 'Send';

        if (btnText) btnText.innerText = 'Generating...';
        if (sendBtn) sendBtn.disabled = true;

        // Add "Thinking..." message
        const loadingId = 'loading-' + Date.now();
        history.innerHTML += `
            <div id="${loadingId}" class="flex gap-3 justify-start">
                <div class="w-8 h-8 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0 animate-pulse">
                    <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                </div>
                <div class="rounded-lg p-3 bg-gray-100 text-gray-500 italic">
                    <p class="text-sm flex items-center gap-2">
                        Thinking
                        <span class="flex gap-1">
                            <span class="w-1 h-1 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0s"></span>
                            <span class="w-1 h-1 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                            <span class="w-1 h-1 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                        </span>
                    </p>
                </div>
            </div>
        `;
        history.scrollTop = history.scrollHeight;
        lucide.createIcons();

        try {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const response = await fetch("{% url 'generate-blog-api' %}", {
                method: "POST",
                headers: { "Content-Type": "application/json", "X-CSRFToken": csrfToken },
                body: JSON.stringify({ message: text })
            });

            // Remove loading message
            const loadingMsg = document.getElementById(loadingId);
            if (loadingMsg) loadingMsg.remove();

            if (!response.ok) throw new Error("API Error");
            const data = await response.json();
            const blogData = data.blog_data || {};

            const messageHtml = marked.parse(data.message || "Done!");

            history.innerHTML += `
                <div class="flex gap-3 justify-start">
                    <div class="w-8 h-8 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i data-lucide="bot" class="w-4 h-4 text-white"></i>
                    </div>
                    <div class="max-w-[80%] rounded-lg p-3 bg-gray-100 text-gray-900 prose prose-sm max-w-none">
                        ${messageHtml}
                    </div>
                </div>
            `;

            history.scrollTop = history.scrollHeight;
            lucide.createIcons();

            // Populate Form Fields
            const titleEl = document.querySelector('[name="title"]');
            if (titleEl && blogData.title) titleEl.value = blogData.title;
            const slugEl = document.querySelector('[name="slug"]');
            if (slugEl && blogData.slug) slugEl.value = blogData.slug;
            const subtitleEl = document.querySelector('[name="subtitle"]');
            if (subtitleEl && blogData.subtitle) subtitleEl.value = blogData.subtitle;
            const excerptEl = document.querySelector('[name="excerpt"]');
            if (excerptEl && blogData.excerpt) excerptEl.value = blogData.excerpt;
            const introEl = document.querySelector('[name="introduction"]');
            if (introEl && blogData.content && blogData.content.introduction) introEl.value = blogData.content.introduction;
            const conEl = document.querySelector('[name="conclusion"]');
            if (conEl && blogData.content && blogData.content.conclusion) conEl.value = blogData.content.conclusion;

            // Load sections
            if (blogData.content && blogData.content.sections && Array.isArray(blogData.content.sections)) {
                // Ensure sections variable is available in scope or global
                sections = blogData.content.sections.map((s, i) => ({ ...s, id: Date.now() + i }));
                renderSections();
                const emptyMsg = document.getElementById('emptySectionsMsg');
                if (emptyMsg) emptyMsg.style.display = 'none';
            }

        } catch (e) {
            console.error(e);
            // Remove loading message if error
            const loadingMsg = document.getElementById(loadingId);
            if (loadingMsg) loadingMsg.remove();
            history.innerHTML += `
                <div class="flex gap-3 justify-start">
                     <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i data-lucide="alert-circle" class="w-4 h-4 text-red-600"></i>
                    </div>
                    <div class="max-w-[80%] rounded-lg p-3 bg-red-50 text-red-800">
                        <p class="text-sm">Error: ${e.message}</p>
                    </div>
                </div>
            `;
        } finally {
            if (btnText) btnText.innerText = originalBtnText;
            if (sendBtn) sendBtn.disabled = false;
        }
    }

    // -----------------------------------------------------
    // Thumbnail Dropzone Logic
    // -----------------------------------------------------
    const dropzone = document.getElementById('dropzone');
    const thumbnailInput = document.getElementById('thumbnailInput');
    const imagePreview = document.getElementById('imagePreview');
    const dropzoneContent = document.getElementById('dropzoneContent');
    const removeImageBtn = document.getElementById('removeImageBtn');

    if (dropzone && thumbnailInput) {
        dropzone.addEventListener('click', (e) => {
            if (e.target !== removeImageBtn && !removeImageBtn.contains(e.target)) {
                thumbnailInput.click();
            }
        });

        thumbnailInput.addEventListener('change', function () {
            handleFiles(this.files);
        });

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropzone.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropzone.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) { dropzone.classList.add('border-indigo-500', 'bg-indigo-50'); }
        function unhighlight(e) { dropzone.classList.remove('border-indigo-500', 'bg-indigo-50'); }

        dropzone.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            thumbnailInput.files = files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length > 0) {
                const file = files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        imagePreview.src = e.target.result;
                        imagePreview.classList.remove('hidden');
                        removeImageBtn.classList.remove('hidden');
                        dropzoneContent.classList.add('hidden');
                    }
                    reader.readAsDataURL(file);
                }
            }
        }
    }

    function removeThumbnail(e) {
        e.stopPropagation();
        thumbnailInput.value = '';
        imagePreview.src = '';
        imagePreview.classList.add('hidden');
        removeImageBtn.classList.add('hidden');
        dropzoneContent.classList.remove('hidden');

        // If there's a way to clear the actual file on server, we might need a hidden checkbox 
        // Django's ClearableFileInput uses a checkbox 'thumbnail-clear'.
        // We might need to handle that if we want to support deleting existing images.
        // For now, this just clears the input for new uploads. 
    }


    // -----------------------------------------------------
    // Section Image Upload Logic
    // -----------------------------------------------------
    async function handleSectionImageUpload(id, inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        const statusLabel = document.getElementById(`upload-status-${id}`);
        if (statusLabel) statusLabel.classList.remove('hidden');

        const formData = new FormData();
        formData.append('image', file);

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        try {
            const response = await fetch("{% url 'upload-image-api' %}", {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
                body: formData
            });

            if (!response.ok) {
                throw new Error(await response.text());
            }

            const data = await response.json();
            if (data.url) {
                updateSectionValue(id, 'imageUrl', data.url);
                renderSections();
            } else {
                throw new Error("No URL returned");
            }

        } catch (error) {
            console.error("Upload failed", error);
            alert("Upload failed: " + error.message);
            if (statusLabel) statusLabel.classList.add('hidden');
        }
    }

    // -----------------------------------------------------
    // Form Submission
    // -----------------------------------------------------
    document.getElementById('blogForm').addEventListener('submit', function (e) {
        // Serialize sections to hidden input
        const sectionsInput = document.getElementById('sectionsInput');
        sectionsInput.value = JSON.stringify(sections);
    });

</script>
{% endblock %}